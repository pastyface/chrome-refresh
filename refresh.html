<script src="json2.js" type="text/javascript"></script>
<script>
    
    var cr = {};
    cr.reloadingTabs = {};
    
    cr.doLogging = false;
    
    cr.isRegistered = function(tabId){
      cr.log('isRegistered tab:'+tabId+
             ' registered:'+(cr.reloadingTabs[tabId] !== undefined));
      
      return cr.reloadingTabs[tabId] !== undefined;
    }
    
    cr.registerTabReload = function(tab, seconds, stick, countdown){
      cr.log('registerTabReload tab:'+tab.id+' seconds:'+seconds+' stick:'+stick);
    
      cr.unregisterTabReload(tab);
      if(seconds < 1) return;
      
      var nextUpdate = new Date().getTime() + (seconds * 1000);
      
      var props = { tab: tab, 
                    timeout: seconds, 
                    nextUpdate: nextUpdate,
                    countdown: countdown,
                    stick: stick, 
                    url: tab.url, 
                    title: tab.title 
                  };
                  
      props.intervalID = setInterval('cr.reloadTab('+tab.id+')', seconds * 1000 );
      cr.reloadingTabs[tab.id] = props;
      cr.updateIcon(tab.id);
      
      if(countdown && !cr.countdownIntervalID){
        cr.countdownIntervalID = setInterval('cr.updateCountdown()', 1000 );
      }
      
      if(countdown) cr.updateCountdown(true);
      
      return props;
    }
    
    cr.unregisterTabReload = function(tab){
      cr.log('unregisterTabReload tab:'+tab.id);
      
      var props = cr.reloadingTabs[tab.id];
      if(props){
        clearInterval(props.intervalID);
        delete cr.reloadingTabs[tab.id];
      }
      cr.updateIcon(tab.id);
      
      if(props && props.countdown) {
        chrome.browserAction.setBadgeText({text: '', tabId: tab.id});
      }
      
      return props;
    }
    
    cr.updateIcon = function(tabId){
      cr.log('updateIcon tab:'+tabId);
      
      if(cr.isRegistered(tabId)){
        chrome.browserAction.setIcon({path:"refresh-on.png", tabId: tabId});
      }
      else {
        chrome.browserAction.setIcon({path:"refresh-off.png", tabId: tabId});
      }
    }
    
    cr.reloadTab = function(tabId){
      var props = cr.reloadingTabs[tabId];
      
      //TODO read window scroll position
      
      // reload page
      chrome.tabs.update(tabId, { url: props.tab.url});
      
      //TODO restore window scroll position
      
      props.nextUpdate = new Date().getTime() + (props.timeout * 1000);
      
      if(props.countdown) cr.updateCountdown(true);
      
      cr.log('reloaded win:'+props.tab.windowId+' tab:'+tabId);
    }
    
    cr.loadAllAutos = function(){
      //TODO cache in a js object
    
      var autosJson = localStorage['autos'];
      if(autosJson){
        return JSON.parse(autosJson);
      }
    }
    
    cr.loadAutos = function(url){
      cr.log('loadAutos url:'+url);
      
      var autos = cr.loadAllAutos();
      if(autos){
        var props = autos[url];
        
        if(props) cr.log('found auto for '+url);
            
        return props;
      }
    }
    
    cr.saveAutos = function(props){
      cr.log('saveAutos url:'+props.url);
      
      var autos = cr.loadAllAutos();
      
      if(!autos){
        autos = {};
      }
      
      autos[props.url] = { url: props.url,
                           timeout: props.timeout,
                           stick: props.stick,
                           title: props.title,
                           countdown: props.countdown
                         };
      
      autosJson = JSON.stringify(autos);
      
      localStorage['autos'] = autosJson;
    }
    
    cr.removeAutos = function(url){
      var autos = cr.loadAllAutos();
      
      if(autos){
        delete autos[url];
        
        autosJson = JSON.stringify(autos);
        localStorage['autos'] = autosJson;
      }
    }
    
    cr.log = function(msg){
      if(cr.doLogging){
        var d = new Date();
        console.log(d.getHours() +
              ':' + d.getMinutes() +
              ':' + d.getSeconds() +
              ' ' + msg);
      }
    }
    
    cr.extractDomain = function(url){
      cr.log('cr.extractDomain: '+url);
      
      var pattern=/^([a-zA-Z]+:\/\/[a-zA-Z0-9\.]+)/;
      var result = pattern.exec(url);
      if(result){
        cr.log('cr.extractDomain result: '+result[1]);
        return result[1];
      }
    }
    
    cr.updateCountdown = function(force){
      var key;
      for(key in cr.reloadingTabs) {
        if(typeof cr.reloadingTabs[key] !== 'function') {
          var tabId = parseInt(key);
          
          var props = cr.reloadingTabs[tabId];
          if(!props.countdown){
            continue;
          } 
          
          var millis = props.nextUpdate - new Date().getTime();
          var seconds = 0;
          
          if(millis > 0){
            seconds = millis / 1000;
            seconds = seconds.toFixed();
          }
          
          if(seconds >= 60){
            var minutes = seconds/60;
            minutes = minutes.toFixed();
            chrome.browserAction.setBadgeBackgroundColor({color: [0,0,255,255], tabId: tabId});
            chrome.browserAction.setBadgeText({text: ''+minutes, tabId: tabId});
          }
          else {
            if(force || seconds <= 10 || seconds % 10 === 0){
              chrome.browserAction.setBadgeBackgroundColor({color: [255,0,0,255], tabId: tabId});
              chrome.browserAction.setBadgeText({text: ''+seconds, tabId: tabId});
            }
          }
          
        }
      }
    }
    
    // Update the icon when the current tab changes
    chrome.tabs.onSelectionChanged.addListener(function(tabId, selectInfo) {
      cr.log('onSelectionChanged win:'+selectInfo.windowId+' tab:'+tabId);
      
      cr.updateIcon(tabId);
    });
    
    chrome.tabs.onRemoved.addListener(function(tabId) {
      var props = cr.reloadingTabs[tabId];
      if(props){
        cr.unregisterTabReload(props.tab);
      }
    });
    
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      var props = cr.reloadingTabs[tabId];
      
      if(!props){
          props = cr.loadAutos(tab.url);
      }
      
      if(!props) return;
      
      if(!props.tab) props.tab = tab;
      
      var tab_stick = props.stick;
      
      if(!tab_stick) tab_stick = localStorage['tab_stick'];
      
      if(!tab_stick) tab_stick = 'url';
      
      switch(tab_stick){
        
        case 'tab':
            cr.registerTabReload(tab, props.timeout, tab_stick, props.countdown);
            break;
        case 'site':
            if(cr.extractDomain(props.url) === cr.extractDomain(tab.url)){
              cr.registerTabReload(tab, props.timeout, tab_stick, props.countdown);
            }
            else {
              cr.unregisterTabReload(tab);
            }
            break;
        case 'url': // fall through
        default:
            if(props.url === tab.url){
              cr.registerTabReload(tab, props.timeout, tab_stick, props.countdown);
            }
            else {
              cr.unregisterTabReload(tab);
            }
        }
    });
    
</script>
